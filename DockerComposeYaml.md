# Структура файла Docker Compose 

Файл Docker-compose описывает процесс загрузки и настройки контейнеров.

```
Файл Docker Compose – это YAML-файл docker-compose.yaml со следующим содержанием:

version: '3.7'
services:
  app1:
    container_name: nginx
    image: "nginx"
    ports:
      - "80:80"
    restart: always
  app2:
    container_name: redis
    image: "redis"
    restart: always
    volumes:
      - /mnt/logs:/logs
      - /mnt/data:/data

x-yc-disks:
  - device_name: compute-disk-data
    fs_type: ext4
    host_path: /mnt/data
    partition: 1
  - device_name: compute-disk-data
    fs_type: ext4
    host_path: /mnt/logs
    partition: 2
```

Где:

* version – тег версии спецификации, с которого должен начинаться файл.
* services – раздел, в котором описываются сервисы.
* container_name – имя запускаемого Docker-контейнера.
* image – имя Docker-образа, на основе которого будет создан и запущен Docker-контейнер.
* ports – используется для перенаправления портов сервиса. Указывается в виде: <порт компьютера>:<порт контейнера>.
* restart – настройка политики перезапуска Docker-контейнера.
* volumes – описание томов, используемых в Docker-контейнере.
* x-yc-disks – раздел, в котором описываются подключаемые диски. Представляет собой расширение спецификации Docker Compose. Используется при подготовке к запуску Docker-контейнеров, перед запуском Docker Compose. Docker 
  Compose пропускает этот раздел.
* device_name – имя устройства.
* fs_type – тип файловой системы. Поддерживаются файловые системы ext4 и xfs.
* host_path – директория, в которую монтируется диск.
* partition – используемый раздел диска.

# Настройка файла docker-compose.yml

Чтобы продемонстрировать настройку файла docker-compose.yml и его работу с Docker Compose, мы создадим среду веб-сервера, используя официальный образ Nginx из Docker Hub, публичного реестра Docker. Контейнерная среда будет обслуживать один статичный файл HTML.
Для начала создайте новый каталог в домашнем каталоге и перейдите в него:

> mkdir ~/compose-demo
> cd ~/compose-demo

Настройте в этом каталоге папку приложения, которая будет выступать в качестве корневого каталога документов для вашей среды Nginx:

> mkdir app

Создайте в предпочитаемом текстовом редакторе новый файл index.html в папке app:

> nano app/index.html

Вставьте в файл следующее содержимое:

```
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Docker Compose Demo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.min.css">
</head>
<body>

	<h1>This is a Docker Compose Demo Page.</h1>
	<p>This content is being served by an Nginx container.</p>

</body>
</html>
```

Сохраните и закройте файл после завершения. Если вы использовали nano, нажмите CTRL+X, а затем Y и ENTER для подтверждения.
Затем создайте файл docker-compose.yml:

> nano docker-compose.yml

Вставьте в файл docker-compose.yml следующее содержимое:

```
version: '3.7'
services:
  web:
    image: nginx:alpine
    ports:
      - "8000:80"
    volumes:
      - ./app:/usr/share/nginx/html
```

Файл docker-compose.yml обычно начинается с определения версии. Оно показывает Docker Compose, какую версию конфигурации мы используем.
Далее идет блок services, где настраиваются службы, являющиеся частью этой среды. В нашем примере у нас имеется одна служба с именем web. Эта служба использует образ nginx:alpine и настраивает переадресацию портов с помощью директивы ports. Все запросы порта 8000 на компьютере host (система, где вы запускаете Docker Compose) будут перенаправляться в контейнер web на порту 80, где будет работать Nginx.
Директива volumes создаст общий том для хоста и контейнера. Контейнер будет предоставлен доступ к локальной папке app, а том будет располагаться в каталоге /usr/share/nginx/html внутри контейнера, который заменит корневой каталог документов Nginx по умолчанию.
Сохраните и закройте файл.
Мы настроили демонстрационную страницу и файл docker-compose.yml для создания контейнерной среды веб-сервера, которая будет обслуживать ее. На следующем шаге мы запустим эту среду с помощью Docker Compose.

# Запуск Docker Compose

Теперь у нас имеется файл docker-compose.yml, и мы можем использовать Docker Compose для запуска нашей среды. Следующая команда загрузит необходимые образы Docker, создаст контейнер для службы web и запустит контейнерную среду в фоновом режиме:

> docker-compose up -d

Docker Compose будет вначале искать заданный образ в локальной системе, и если не найдет его, загрузит его из Docker Hub. Вывод будет выглядеть следующим образом:
Теперь ваша среда запущена в фоновом режиме. Для проверки активности контейнера используйте следующую команду:

> docker-compose ps

Эта команда покажет вам информацию о работающих контейнерах и их состоянии, а также о действующей переадресации портов:
Для получения доступа к демонстрационному приложению введите в браузере адрес localhost:8000, если оно запущено на локальном компьютере, или your_server_domain_or_IP:8000, если оно запущено на удаленном сервере.
Страница будет выглядеть следующим образом:
Заданный в файле docker-compose.yml общий том синхронизирует файлы в папке app с корневым каталогом документов контейнера. Если вы внесете любые изменения в файл index.html, они будут автоматически отражены в контейнере и появятся в браузере после перезагрузки страницы.

# Команды Docker Compose

Давайте посмотрим, как использовать команды Docker Compose для управления контейнерной средой и взаимодействия с ней.
Чтобы посмотреть журналы контейнера Nginx, используйте команду logs:

> docker-compose logs

Если вы хотите приостановить работу среды без изменения текущего состояния ваших контейнеров, используйте команду:

> docker-compose pause

Чтобы возобновить работу после приостановки, используйте команду:

> docker-compose unpause

Команда stop останавливает выполнение контейнера, но не уничтожает данные, связанные с вашими контейнерами:

> docker-compose stop

Если вы хотите удалить контейнеры, сети и тома, связанные с контейнерной средой, используйте команду down:

> docker-compose down

Обратите внимание, что при этом не будет удален базовый образ, используемый Docker Compose для запуска нашей среды (в нашем примере nginx:alpine). Так, при повторном запуске среды с помощью команды docker-compose up процесс будет намного быстрее, поскольку образ уже находится в вашей системе.
Если вы хотите удалить из системы базовый образ, используйте команду:

> docker image rm nginx:alpine
